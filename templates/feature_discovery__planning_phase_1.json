{
  "name": "Feature Discovery & Planning (Phase 1)",
  "content": "# Feature Discovery & Planning Workflow - Phase 1\n\n# \u26a0\ufe0f CONTEXT INSTRUCTIONS FOR AI AGENT\n\n**CRITICAL**: Do NOT search @workspace at the start of this workflow.\n\nSearching @workspace prematurely will pollute your context with irrelevant files, feature specs, and code. This document contains structured instructions with explicit steps that tell you WHEN to search.\n\n**When you need workspace context**: Specific steps below will say \"Search @workspace for X\". Only search at those explicit checkpoints.\n\n---\n\n**Your Task**: Discover the next feature, analyze it, assess risks, generate approval spec, and **create a state file**.\n\n**Output Goal**: State file at `docs/agentic_feature_implementation/{NN}_{feature_name}/workflow_state_phase1.json` (version-controlled, portable across machines)\n\n---\n\n## Context\n\n- **Phase 1** (NOW): Discovery \u2192 Analysis \u2192 Risks \u2192 Approval \u2192 State File\n- **Phase 2** (NEXT): Implementation using state file context\n- **Phase 3** (FINAL): Archive + documentation updates\n\n**Input**: `{{feature_context}}`\n- If provided \u2192 analyze that specific feature\n- If empty \u2192 auto-discover next feature\n\n**Constraints**:\n- Follow AGENTS.md (\u2264400 LOC/file, \u226475 LOC/function, \u226585% coverage, TDD)\n- Feature flags default OFF\n- No breaking changes without approval\n\n---\n\n## Step 0: Rebuild Workspace Index\n\n**ALWAYS rebuild the workspace index at the start of each feature discovery.**\n\n**Why**: The index becomes stale quickly as features are implemented. Rebuilding ensures accurate context.\n\n**Command**:\n```bash\nprompt-automation --index-workspace\n```\n\n**What happens**:\n- Scans workspace (~2s for 817 files)\n- Builds `.prompt-automation-index.json`\n- Enables fast context gathering in Step 2\n\n**Skip if**:\n- `PA_SKIP_WORKSPACE_INDEX=1` is set\n- Index was just rebuilt (<5 min ago)\n\n**Output**:\n```\n\u2713 Workspace index built successfully\n  Indexed: 817 files\n  Time: 1.8s\n```\n\n---\n\n## Step 1: Discover Feature\n\n### Step 1a: Check for Existing State File (Resume Check)\n\n**BEFORE discovering a new feature**, check if there's an existing state file that indicates a paused implementation.\n\n**If `{{feature_context}}` is provided:**\n\n1. Check for state file: `docs/agentic_feature_implementation/{{feature_context}}/workflow_state_phase1.json`\n2. If found, read the `_resume_instructions` field\n3. **\u23f8\ufe0f ASK USER**: \"Found paused implementation for this feature. Would you like to resume? (Y/n)\"\n   - If YES \u2192 Skip to Step 5 and load the existing state\n   - If NO \u2192 Continue with fresh discovery\n\n**Output if state file found**:\n```markdown\n## \ud83d\udd04 Resume Available\n\n**Feature**: {feature_title from state}\n**Last Checkpoint**: {_resume_instructions.last_checkpoint}\n**Resume Command**: {_resume_instructions.command}\n\nWould you like to:\n1. **Resume** from where you left off (load existing state)\n2. **Restart** feature discovery from scratch (overwrites state)\n\n**Your choice**: {1 or 2}\n```\n\n---\n\n### Step 1b: Feature Discovery (New Implementation)\n\n**Search** `@workspace` for features:\n\n1. **Location**: `docs/agentic_feature_implementation/`\n2. **Pattern**: `{NN}_{feature_name}/feature_spec.md`\n3. **Exclude**: `_archive/` folder\n\n**Selection Logic**:\n- If `{{feature_context}}` provided \u2192 use that folder\n- Else \u2192 find folders NOT in `_archive/`, pick by:\n  - Lowest folder number with met dependencies\n  - OR most recently modified (fallback)\n\n**Read** the `feature_spec.md` and extract:\n- Feature ID (from metadata)\n- Title\n- Dependencies (check if each exists in `_archive/`)\n\n**Output**:\n\n```markdown\n## Discovery Results\n\n**Selected Feature**: `{NN}_{feature_name}`\n**Title**: {title}\n**Path**: `docs/agentic_feature_implementation/{NN}_{feature_name}/feature_spec.md`\n**Dependencies**: \n  - {dep1}: \u2705 implemented (in _archive/)\n  - {dep2}: \u274c missing (blocks implementation)\n**Status**: {READY or BLOCKED}\n\n**Proceed with this feature?** (Y/n)\n```\n\n**\u23f8\ufe0f STOP**: Wait for user confirmation before continuing to Step 2.\n\n---\n\n## Step 1.5: Classify Feature as MAJOR or MINOR\n\n**CRITICAL**: Determine if this feature requires full TDD pipeline (MAJOR) or quick implementation (MINOR).\n\n**Read** `feature_spec.md` and extract:\n- Estimated effort (days)\n- Estimated LOC (lines of code)\n- New dependencies required (libraries, MCPs)\n- Breaking changes (API modifications)\n- Integration points (GUI, CLI, pipeline, MCP)\n- Extension of existing feature (Feature 01-23)\n\n**Apply 6-Criteria Test** (ALL must pass for MINOR):\n\n| Criterion | Threshold | Status |\n|-----------|-----------|--------|\n| 1. Effort | \u22641 day | \u2705/\u274c |\n| 2. LOC | \u2264150 lines | \u2705/\u274c |\n| 3. Dependencies | No new libraries/MCPs | \u2705/\u274c |\n| 4. Breaking Changes | None (additive only) | \u2705/\u274c |\n| 5. Integration Points | Single (GUI-only OR CLI-only) | \u2705/\u274c |\n| 6. Extends Existing | Yes (enhances Feature NN) | \u2705/\u274c |\n\n**Classification Logic**:\n- **ALL 6 \u2705** \u2192 MINOR Feature (quick add, 0.5-1 day, stub-driven)\n- **ANY \u274c** \u2192 MAJOR Feature (full pipeline, plan.md, tasks.md, TDD)\n\n**Output**:\n\n```markdown\n## Feature Classification\n\n**Feature**: {NN}_{feature_name}\n**Title**: {title}\n\n### Classification Criteria Analysis\n\n| Criterion | Threshold | Actual | Status |\n|-----------|-----------|--------|--------|\n| Effort | \u22641 day | {X} days | \u2705/\u274c |\n| LOC | \u2264150 | ~{Y} LOC | \u2705/\u274c |\n| New Dependencies | None | {list or \"None\"} | \u2705/\u274c |\n| Breaking Changes | None | {list or \"None\"} | \u2705/\u274c |\n| Integration Points | 1 | {count}: {list} | \u2705/\u274c |\n| Extends Existing | Yes | Feature {NN} or \"No\" | \u2705/\u274c |\n\n### Classification Result\n\n**Type**: {MAJOR \u2b50 / MINOR \ud83d\udd39}\n\n**Reasoning**: {If MINOR: \"All 6 criteria met: quick add to existing {module}.\" | If MAJOR: \"Criterion {N} failed: {reason}.\"}\n\n**Workflow Path**:\n- {MAJOR: \"Full TDD pipeline (plan.md, tasks.md, manual test guide)\" | MINOR: \"Simplified workflow (stub-driven, quick implementation)\"}\n```\n\n**\u23f8\ufe0f CHECKPOINT**: If you discover **multiple features** (both MAJOR and MINOR), present **user choice prompt** before proceeding:\n\n```markdown\n## Multiple Features Found\n\nI found both MAJOR and MINOR features ready for implementation:\n\n### 1. \u2b50 MAJOR: Feature {NN} - {title}\n- **Effort**: {X} days\n- **Classification**: {criterion that failed}\n- **Workflow**: Full TDD pipeline (plan.md, tasks.md, 2-5 days)\n- **Output**: `docs/agentic_feature_implementation/{NN}_{name}/` (full folder)\n\n### 2. \ud83d\udd39 MINOR: Feature {MM} - {title}\n- **Effort**: {Y} days (\u22641 day)\n- **Classification**: All 6 criteria met \u2705\n- **Workflow**: Quick add (stub-driven, 0.5-1 day)\n- **Output**: `minor_features/{MM}_{name}.md` (stub only)\n\n**Which feature would you like to focus on?**\n- Enter **1** for MAJOR feature (full pipeline)\n- Enter **2** for MINOR feature (quick add)\n\n**Your choice**: {1 or 2}\n```\n\n**After user selection**: Proceed with selected feature to Step 2.\n\n---\n\n## Step 2: Extract Definition of Done\n\n**Read** the complete `feature_spec.md` and extract:\n\n1. **Acceptance Criteria** (from spec)\n2. **Files to Create** (from Implementation Plan)\n3. **Files to Modify** (from Implementation Plan)\n4. **Documentation to Update** (from spec)\n\n**Gather Workspace Context** (Optional - skip if not needed):\n\nUse Feature 001 (Workspace Context Gatherer) to understand existing code structure:\n\n```python\nfrom prompt_automation.workspace.context_gatherer import ContextGatherer\nfrom pathlib import Path\n\ngatherer = ContextGatherer(Path.cwd())\ncontext = gatherer.gather_for_feature(\"{feature_title}\")  # Returns LLM-ready Markdown\n```\n\n**When to skip**:\n- Small changes (1-2 files, no workspace context needed)\n- Documentation-only work (README, docs updates)\n- Very large workspaces (>5000 files, use manual search)\n\n**How to disable**:\n```python\n# Skip indexing (use live search only)\ngatherer = ContextGatherer(Path.cwd(), use_index=False)\n\n# Or set environment variable\n# export PA_SKIP_WORKSPACE_INDEX=1\n```\n\n**Context provides**:\n- Related files and functions\n- Existing patterns to reuse\n- Integration points\n- Relevant tests\n\n**Derive DoD**:\n- Map each acceptance criterion \u2192 test case\n- Add standard checks (coverage \u226585%, existing tests pass, docs updated)\n\n**Output**:\n\n```markdown\n## Scope & Definition of Done\n\n**Purpose**: {1-2 sentence summary}\n\n**Deliverables**:\n- Create: `{file1.py}` - {purpose}\n- Modify: `{file2.py}` - {changes}\n- Update: `README.md`, `CHANGELOG.md`\n\n**Definition of Done**:\n- [ ] {Acceptance criterion 1} \u2192 Test: `tests/{path}/test_{name}.py::{test_fn}`\n- [ ] {Acceptance criterion 2} \u2192 Test: `tests/{path}/test_{name}.py::{test_fn}`\n- [ ] Coverage \u226585% for new modules\n- [ ] All existing tests pass\n- [ ] Documentation updated\n- [ ] Feature flag implemented (default OFF)\n\n**Non-Goals** (Out of Scope):\n- {Item 1}\n- {Item 2}\n```\n\n---\n\n## Step 3: Assess Risks\n\n**Analyze** impact:\n\n1. **Public API changes?** \u2192 HIGH RISK\n2. **Core flow changes?** \u2192 HIGH RISK  \n3. **New dependencies?** \u2192 MEDIUM RISK\n4. **Data/schema changes?** \u2192 MEDIUM RISK\n\n**Use Workspace Context** (if gathered in Step 2):\n- Identify files that import modules to be modified (breaking change risk)\n- Find similar features to reuse patterns (reduce risk)\n- Locate existing tests to extend (integration risk)\n\n**Check** spec for \"Critical Questions & Risks\" section.\n\n**Output**:\n\n```markdown\n## Risk Assessment\n\n**Risk Level**: {HIGH / MEDIUM / LOW}\n\n**High Risks**:\n1. {Risk title}\n   - Issue: {description}\n   - Impact: {what breaks}\n   - Mitigation: {specific action}\n\n**Medium Risks**:\n{same format}\n\n**Unknowns**:\n- {Question} \u2192 Assume: {assumption} \u2192 Validate: {how}\n```\n\n---\n\n## Step 4: Generate Approval Spec\n\n**Summarize** Steps 2-3 for stakeholder review.\n\n**Output**:\n\n```markdown\n## Approval Spec\n\n**Feature**: {title}\n**Estimated Effort**: {hours from spec}\n**Risk Level**: {HIGH/MEDIUM/LOW}\n\n**Summary**: {2-3 sentences describing what will change}\n\n**Impact**:\n- Files: {N files created, M modified}\n- Public APIs: {yes/no - details}\n- Dependencies: {yes/no - list}\n- Breaking changes: {yes/no - details}\n\n**High-Risk Items**: {list from Step 3}\n\n---\n\n**Approval Options**:\n\n1. **Approve - Direct Implementation** (Phase 2a)\n   - AI implements code using TDD\n   - Timeline: {estimate}\n   - Next: Run Phase 2a (Template 13024)\n\n2. **Approve - Generate Meta-Prompt** (Phase 2b)\n   - AI generates implementation guide\n   - You implement manually or with external LLM\n   - Next: Run Phase 2b (Template 13016)\n\n3. **Request Changes**\n   - Specify edits \u2192 regenerate this approval spec\n\n4. **Defer Feature**\n   - Move to `_archive/deferred/`\n\n**Your decision**: {1, 2, 3, or 4}\n```\n\n**\u23f8\ufe0f STOP HERE - BRANCH DECISION REQUIRED**\n\nWait for user's approval decision. If they choose Option 1 or 2, proceed to Step 5 to create the state file.\n\n---\n\n## Step 5: Create State File\n\n**After approval**, create the state file for Phase 2 handoff.\n\n**File Path**: `docs/agentic_feature_implementation/{NN}_{feature_name}/workflow_state_phase1.json`\n\n**Why in feature folder?**\n- Version controlled with the feature spec\n- Portable across machines (git pull \u2192 resume)\n- Editable for cross-device collaboration\n\n**JSON Structure**:\n\n```json\n{\n  \"_resume_instructions\": {\n    \"message\": \"This feature implementation was paused. To resume:\",\n    \"command\": \"prompt-automation --template 13024 --var 'feature_id={feature_id}'\",\n    \"alternative\": \"In Copilot Chat, say: 'Resume feature {NN} implementation'\",\n    \"last_checkpoint\": \"Phase 1 complete - approval granted for {direct AI / meta-prompt} implementation\",\n    \"next_step\": \"Phase 2{a/b}: {Implementation / Meta-prompt generation}\"\n  },\n  \"phase\": 1,\n  \"feature_id\": \"{feature_id_from_spec}\",\n  \"feature_folder\": \"{NN}_{feature_name}\",\n  \"feature_title\": \"{title}\",\n  \"spec_path\": \"docs/agentic_feature_implementation/{NN}_{feature_name}/feature_spec.md\",\n  \"timestamp\": \"{ISO 8601 timestamp}\",\n  \"approval_decision\": {1 or 2},\n  \"feature_classification\": \"{MAJOR | MINOR}\",\n  \"classification_reasoning\": \"{explanation}\",\n  \"classification_criteria\": {\n    \"effort_days\": {N},\n    \"estimated_loc\": {N},\n    \"new_dependencies\": {true | false},\n    \"breaking_changes\": {true | false},\n    \"integration_points\": {N},\n    \"extends_existing\": \"{Feature NN or null}\"\n  },\n  \"workflow_path\": \"{simplified | full}\",\n  \"scope\": {\n    \"purpose\": \"{brief summary}\",\n    \"files_to_create\": [\"{file1}\", \"{file2}\"],\n    \"files_to_modify\": [\n      {\"path\": \"{file}\", \"changes\": \"{description}\"}\n    ],\n    \"docs_to_update\": [\"README.md\", \"CHANGELOG.md\"]\n  },\n  \"dod\": [\n    {\"criterion\": \"{description}\", \"test\": \"{test_path}\", \"met\": false}\n  ],\n  \"risks\": {\n    \"level\": \"{HIGH/MEDIUM/LOW}\",\n    \"high\": [{\"title\": \"...\", \"mitigation\": \"...\"}],\n    \"medium\": [],\n    \"unknowns\": []\n  },\n  \"estimate_hours\": {N}\n}\n```\n\n**ACTION**: Use a tool or write command to create this file.\n\n**Confirmation**:\n\n```markdown\n## \u2705 Phase 1 Complete\n\n**State File Created**: `docs/agentic_feature_implementation/{NN}_{feature_name}/workflow_state_phase1.json`\n\n**Next Steps - BRANCH DECISION**:\n\nYou chose: **Option {1 or 2}**\n\n### Path A: Direct AI Implementation (Template 13024)\n\nAI will implement using TDD cycle. Run:\n\n```bash\n# Generate Phase 2a instructions\n./scripts/feature_workflow_copilot.sh --phase 2 {feature_id}\n\n# OR directly with prompt-automation CLI\nprompt-automation --template 13024 --var \"feature_id={feature_id}\"\n```\n\n### Path B: Meta-Prompt Generation (Template 13016)\n\nAI generates detailed guide, you implement manually. Run:\n\n```bash\nprompt-automation --template 13016 --var \"feature_id={feature_id}\"\n```\n\n**\u26a0\ufe0f STOP HERE**: Choose your path (A or B) and run the appropriate command above.\n```\n\n---\n\n## Quality Checklist\n\nBefore finalizing, verify:\n- [ ] Feature discovered and dependencies validated\n- [ ] DoD is measurable (each criterion has a test)\n- [ ] All HIGH and MEDIUM risks have mitigations\n- [ ] Approval spec is concise (<500 words)\n- [ ] State file JSON is valid and complete\n- [ ] User has confirmed approval decision",
  "description": "This template analyzes a single feature specification to help you understand requirements, assess risks, and get stakeholder approval before implementation. It extracts Definition of Done from acceptance criteria, performs risk assessment (HIGH/MEDIUM/LOW), and generates a 4-option approval spec. Output: comprehensive feature analysis with scope, files to create/modify, DoD checklist, and workflow state file for Phase 2 handoff. Use when starting feature implementation (Phase 1 of agentic workflow).",
  "trigger": ":feature_di",
  "variables": [
    {
      "name": "feature_context",
      "label": "Optional: Specific feature folder (e.g. '00_test_feature'). Leave empty for auto-discovery."
    }
  ]
}